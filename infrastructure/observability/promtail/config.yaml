server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # Scrape application logs from logs directory
  - job_name: application-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: application-logs
          environment: development
          __path__: /logs/*/*.log

    pipeline_stages:
      # Parse JSON logs
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            service: service
            environment: environment
            correlationId: correlationId
            type: type

      # Set timestamp
      - timestamp:
          source: timestamp
          format: RFC3339Nano

      # Set labels
      - labels:
          service:
          environment:
          level:
          type:
          correlationId:

      # Drop health check and metrics logs
      - drop:
          expression: '.*(/health|/metrics).*'
          drop_counter_reason: health_metrics_logs

  # Scrape API Gateway logs
  - job_name: api-gateway
    static_configs:
      - targets:
          - localhost
        labels:
          job: api-gateway
          service: api-gateway
          environment: development
          __path__: /logs/api-gateway/*.log

    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            correlationId: correlationId
            method: method
            path: path
            statusCode: statusCode
            duration: duration

      - timestamp:
          source: timestamp
          format: RFC3339Nano

      - labels:
          level:
          correlationId:
          method:
          path:

  # Scrape service logs
  - job_name: microservices
    static_configs:
      - targets:
          - localhost
        labels:
          job: microservices
          environment: development
          __path__: /logs/*-service/*.log

    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            service: service
            correlationId: correlationId
            type: type

      - timestamp:
          source: timestamp
          format: RFC3339Nano

      - labels:
          service:
          level:
          type:
          correlationId:

  # Scrape system logs
  - job_name: system
    static_configs:
      - targets:
          - localhost
        labels:
          job: system-logs
          environment: development
          __path__: /var/log/syslog

    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\w+ \d+ \d+:\d+:\d+) (?P<hostname>\S+) (?P<service>\S+)(\[(?P<pid>\d+)\])?: (?P<message>.+)$'

      - timestamp:
          source: timestamp
          format: Jan 2 15:04:05

      - labels:
          hostname:
          service:
