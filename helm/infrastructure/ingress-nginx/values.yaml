# NGINX Ingress Controller configuration
controller:
  replicaCount: 3

  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi

  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 10
    targetCPUUtilizationPercentage: 80
    targetMemoryUtilizationPercentage: 80

  # Service configuration
  service:
    enabled: true
    type: LoadBalancer
    annotations:
      cloud.google.com/load-balancer-type: "External"
      cloud.google.com/backend-config: '{"default": "pss-nano-backend-config"}'
    externalTrafficPolicy: Local

  # Configuration
  config:
    # Performance
    worker-processes: "auto"
    max-worker-connections: "65536"
    use-gzip: "true"
    gzip-level: "5"
    enable-brotli: "true"

    # Security
    ssl-protocols: "TLSv1.2 TLSv1.3"
    ssl-ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384"
    ssl-prefer-server-ciphers: "true"
    ssl-session-cache: "true"
    ssl-session-timeout: "10m"

    # HSTS
    hsts: "true"
    hsts-max-age: "31536000"
    hsts-include-subdomains: "true"
    hsts-preload: "true"

    # Rate limiting
    limit-req-status-code: "429"
    limit-conn-zone-variable: "$binary_remote_addr"

    # Timeouts
    proxy-connect-timeout: "60"
    proxy-send-timeout: "60"
    proxy-read-timeout: "60"
    proxy-body-size: "10m"

    # Client settings
    client-header-buffer-size: "64k"
    large-client-header-buffers: "4 64k"
    client-body-buffer-size: "128k"

    # Logging
    log-format-upstream: '{"time": "$time_iso8601", "remote_addr": "$remote_addr", "x_forwarded_for": "$proxy_add_x_forwarded_for", "request_id": "$req_id", "remote_user": "$remote_user", "bytes_sent": $bytes_sent, "request_time": $request_time, "status": $status, "vhost": "$host", "request_proto": "$server_protocol", "path": "$uri", "request_query": "$args", "request_length": $request_length, "duration": $request_time, "method": "$request_method", "http_referrer": "$http_referer", "http_user_agent": "$http_user_agent", "upstream_addr": "$upstream_addr", "upstream_status": "$upstream_status", "upstream_response_time": "$upstream_response_time"}'

    # Enable real IP
    use-forwarded-headers: "true"
    compute-full-forwarded-for: "true"
    use-proxy-protocol: "false"

  # Metrics
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      interval: 30s

  # Pod anti-affinity
  affinity:
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - ingress-nginx
          topologyKey: kubernetes.io/hostname

  # Pod disruption budget
  podDisruptionBudget:
    enabled: true
    minAvailable: 2

  # Security context
  podSecurityPolicy:
    enabled: true

  securityContext:
    runAsNonRoot: true
    runAsUser: 101
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
      add:
        - NET_BIND_SERVICE

# Default backend
defaultBackend:
  enabled: true
  replicaCount: 2
  resources:
    limits:
      cpu: 50m
      memory: 64Mi
    requests:
      cpu: 25m
      memory: 32Mi

# RBAC
rbac:
  create: true

# Service account
serviceAccount:
  create: true
  name: ingress-nginx
