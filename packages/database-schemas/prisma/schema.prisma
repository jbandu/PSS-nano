// Airline PSS Platform - Centralized Database Schema
// Multi-tenant architecture with comprehensive airline operations support

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ORGANIZATION & MULTI-TENANCY
// ============================================================================

model Organization {
  id                    String                  @id @default(uuid())
  code                  String                  @unique // IATA airline code (e.g., "AA", "DL")
  name                  String
  legalName             String
  iataCode              String?                 @unique
  icaoCode              String?                 @unique
  country               String
  currency              String                  @default("USD")
  timezone              String                  @default("UTC")
  settings              Json?                   // Organization-specific settings
  status                OrganizationStatus      @default(ACTIVE)
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  deletedAt             DateTime?

  // Relationships
  users                 User[]
  flights               Flight[]
  pnrs                  PNR[]
  passengers            Passenger[]
  fares                 Fare[]
  ancillaryProducts     AncillaryProduct[]
  payments              Payment[]
  checkInTransactions   CheckInTransaction[]
  boardingRecords       BoardingRecord[]
  baggageTags           BaggageTag[]
  campaigns             Campaign[]

  @@index([code])
  @@index([iataCode])
  @@index([status])
  @@map("organizations")
}

enum OrganizationStatus {
  ACTIVE
  SUSPENDED
  INACTIVE
}

// ============================================================================
// CORE ENTITIES - PNR & PASSENGERS
// ============================================================================

model PNR {
  id                    String                  @id @default(uuid())
  organizationId        String
  locator               String                  @unique // 6-character alphanumeric
  status                PNRStatus               @default(ACTIVE)
  bookingChannel        BookingChannel          @default(WEB)
  bookingSource         String?                 // Agency code, website, etc.
  
  // Contact information
  contactEmail          String
  contactPhone          String
  contactName           String?
  
  // Booking details
  totalAmount           Decimal                 @db.Decimal(10, 2)
  currency              String                  @default("USD")
  bookingDate           DateTime                @default(now())
  ticketTimeLimit       DateTime?
  
  // Payment status
  paymentStatus         PaymentStatus           @default(PENDING)
  paidAmount            Decimal                 @default(0) @db.Decimal(10, 2)
  
  // Metadata
  metadata              Json?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  deletedAt             DateTime?               // Soft delete

  // Relationships
  organization          Organization            @relation(fields: [organizationId], references: [id])
  passengers            Passenger[]
  segments              PNRSegment[]
  payments              Payment[]
  ancillaries           PNRAncillary[]
  tickets               Ticket[]
  checkIns              CheckInTransaction[]
  specialRequests       SpecialServiceRequest[]
  
  @@index([organizationId])
  @@index([locator])
  @@index([contactEmail])
  @@index([status])
  @@index([bookingDate])
  @@index([deletedAt])
  @@map("pnrs")
}

enum PNRStatus {
  ACTIVE
  CONFIRMED
  TICKETED
  CANCELLED
  EXPIRED
  NO_SHOW
}

enum BookingChannel {
  WEB
  MOBILE
  AGENT
  API
  GDS
  CALL_CENTER
  KIOSK
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  REFUNDED
  FAILED
}

model PNRSegment {
  id                    String                  @id @default(uuid())
  pnrId                 String
  flightId              String
  segmentNumber         Int                     // 1, 2, 3, etc.
  
  // Flight details
  origin                String                  // IATA airport code
  destination           String                  // IATA airport code
  departureDate         DateTime
  arrivalDate           DateTime
  
  // Cabin and class
  cabinClass            CabinClass
  bookingClass          String                  // Fare class (Y, J, F, etc.)
  fareBasis             String?
  
  // Status
  status                SegmentStatus           @default(CONFIRMED)
  
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt

  // Relationships
  pnr                   PNR                     @relation(fields: [pnrId], references: [id], onDelete: Cascade)
  flight                Flight                  @relation(fields: [flightId], references: [id])
  
  @@unique([pnrId, segmentNumber])
  @@index([pnrId])
  @@index([flightId])
  @@index([origin, destination, departureDate])
  @@map("pnr_segments")
}

enum SegmentStatus {
  CONFIRMED
  WAITLISTED
  CANCELLED
  FLOWN
  NO_SHOW
}

model Passenger {
  id                    String                  @id @default(uuid())
  organizationId        String
  pnrId                 String
  
  // Personal information
  passengerType         PassengerType
  title                 String?                 // Mr, Mrs, Ms, Dr, etc.
  firstName             String
  middleName            String?
  lastName              String
  dateOfBirth           DateTime?
  gender                Gender?
  
  // Contact (may differ from PNR contact)
  email                 String?
  phone                 String?
  
  // Frequent flyer
  frequentFlyerNumber   String?
  frequentFlyerTier     String?                 // Silver, Gold, Platinum, etc.
  
  // Travel documents
  passportNumber        String?
  passportCountry       String?
  passportExpiry        DateTime?
  nationality           String?
  
  // Special services
  wheelchairRequired    Boolean                 @default(false)
  mealPreference        String?
  seatPreference        String?
  
  // Metadata
  metadata              Json?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  deletedAt             DateTime?

  // Relationships
  organization          Organization            @relation(fields: [organizationId], references: [id])
  pnr                   PNR                     @relation(fields: [pnrId], references: [id], onDelete: Cascade)
  tickets               Ticket[]
  checkIns              PassengerCheckIn[]
  boardingPasses        BoardingPass[]
  baggageTags           BaggageTag[]
  specialRequests       SpecialServiceRequest[]
  
  @@index([organizationId])
  @@index([pnrId])
  @@index([lastName, firstName])
  @@index([frequentFlyerNumber])
  @@index([email])
  @@index([deletedAt])
  @@map("passengers")
}

enum PassengerType {
  ADULT
  CHILD
  INFANT
  SENIOR
  STUDENT
  MILITARY
}

enum Gender {
  MALE
  FEMALE
  OTHER
  UNSPECIFIED
}

// ============================================================================
// CORE ENTITIES - FLIGHTS & INVENTORY
// ============================================================================

model Flight {
  id                    String                  @id @default(uuid())
  organizationId        String
  
  // Flight identification
  flightNumber          String                  // e.g., "AA100"
  operatingCarrier      String                  // IATA code
  marketingCarrier      String                  // IATA code (for codeshare)
  
  // Route
  origin                String                  // IATA airport code
  destination           String                  // IATA airport code
  
  // Schedule
  scheduledDeparture    DateTime
  scheduledArrival      DateTime
  actualDeparture       DateTime?
  actualArrival         DateTime?
  
  // Aircraft
  aircraftType          String                  // e.g., "Boeing 737-800"
  aircraftRegistration  String?
  tailNumber            String?
  
  // Configuration
  totalSeats            Int
  economySeats          Int
  premiumEconomySeats   Int                     @default(0)
  businessSeats         Int                     @default(0)
  firstSeats            Int                     @default(0)
  
  // Status
  status                FlightStatus            @default(SCHEDULED)
  gate                  String?
  terminal              String?
  
  // Operational
  checkinOpenTime       DateTime?
  checkinCloseTime      DateTime?
  boardingTime          DateTime?
  gateClosureTime       DateTime?
  
  // Metadata
  metadata              Json?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  deletedAt             DateTime?

  // Relationships
  organization          Organization            @relation(fields: [organizationId], references: [id])
  inventory             FlightInventory[]
  pnrSegments           PNRSegment[]
  checkIns              CheckInTransaction[]
  boardingRecords       BoardingRecord[]
  flightOperations      FlightOperation[]
  loadControl           LoadControl?
  
  @@index([organizationId])
  @@index([flightNumber, scheduledDeparture])
  @@index([origin, destination, scheduledDeparture])
  @@index([status])
  @@index([scheduledDeparture])
  @@index([deletedAt])
  @@map("flights")
}

enum FlightStatus {
  SCHEDULED
  DELAYED
  BOARDING
  DEPARTED
  IN_FLIGHT
  LANDED
  ARRIVED
  CANCELLED
  DIVERTED
}

model FlightInventory {
  id                    String                  @id @default(uuid())
  flightId              String
  
  // Class configuration
  cabinClass            CabinClass
  bookingClass          String                  // Y, J, F, etc.
  
  // Inventory
  totalSeats            Int
  availableSeats        Int
  bookedSeats           Int                     @default(0)
  blockedSeats          Int                     @default(0)
  
  // Pricing
  baseFare              Decimal                 @db.Decimal(10, 2)
  currency              String                  @default("USD")
  
  // Availability control
  isAvailable           Boolean                 @default(true)
  oversellLimit         Int                     @default(0)
  
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt

  // Relationships
  flight                Flight                  @relation(fields: [flightId], references: [id], onDelete: Cascade)
  
  @@unique([flightId, cabinClass, bookingClass])
  @@index([flightId])
  @@index([cabinClass])
  @@map("flight_inventory")
}

enum CabinClass {
  ECONOMY
  PREMIUM_ECONOMY
  BUSINESS
  FIRST
}

model SeatMap {
  id                    String                  @id @default(uuid())
  flightId              String
  
  // Seat details
  seatNumber            String                  // e.g., "12A"
  row                   Int
  column                String                  // A, B, C, D, E, F
  
  // Classification
  cabinClass            CabinClass
  seatType              SeatType                @default(STANDARD)
  
  // Characteristics
  isWindow              Boolean                 @default(false)
  isAisle               Boolean                 @default(false)
  isExitRow             Boolean                 @default(false)
  hasExtraLegroom       Boolean                 @default(false)
  
  // Availability
  status                SeatStatus              @default(AVAILABLE)
  passengerId           String?
  blockedBy             String?                 // Agent ID
  blockedUntil          DateTime?
  
  // Pricing
  extraCharge           Decimal?                @db.Decimal(10, 2)
  
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt

  @@unique([flightId, seatNumber])
  @@index([flightId])
  @@index([status])
  @@map("seat_maps")
}

enum SeatType {
  STANDARD
  PREFERRED
  EXTRA_LEGROOM
  EMERGENCY_EXIT
  BASSINET
  BLOCKED
}

enum SeatStatus {
  AVAILABLE
  OCCUPIED
  BLOCKED
  SELECTED
  RESERVED
}

// ============================================================================
// CORE ENTITIES - FARES & PRICING
// ============================================================================

model Fare {
  id                    String                  @id @default(uuid())
  organizationId        String
  
  // Fare identification
  fareCode              String                  @unique
  fareName              String
  fareType              FareType                @default(PUBLISHED)
  
  // Route
  origin                String                  // IATA airport code or country
  destination           String                  // IATA airport code or country
  routeType             RouteType               @default(ONE_WAY)
  
  // Class and cabin
  cabinClass            CabinClass
  bookingClass          String                  // Y, J, F, etc.
  fareBasis             String
  
  // Pricing
  baseFare              Decimal                 @db.Decimal(10, 2)
  currency              String                  @default("USD")
  
  // Taxes and fees (can be JSON array)
  taxes                 Json?                   // [{type: "YQ", amount: 50.00, currency: "USD"}]
  
  // Rules and restrictions
  refundable            Boolean                 @default(false)
  changeable            Boolean                 @default(true)
  changefee             Decimal?                @db.Decimal(10, 2)
  cancelFee             Decimal?                @db.Decimal(10, 2)
  
  // Baggage allowance
  carryOnBags           Int                     @default(1)
  checkedBags           Int                     @default(0)
  baggageWeight         Int?                    // in kg
  
  // Advance purchase
  advancePurchaseMin    Int?                    // days before departure
  advancePurchaseMax    Int?                    // days before departure
  
  // Travel dates
  validFrom             DateTime
  validTo               DateTime
  blackoutDates         Json?                   // Array of date ranges
  
  // Availability
  isActive              Boolean                 @default(true)
  minimumStay           Int?                    // days
  maximumStay           Int?                    // days
  
  // Metadata
  rules                 Json?                   // Complex fare rules
  metadata              Json?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  deletedAt             DateTime?

  // Relationships
  organization          Organization            @relation(fields: [organizationId], references: [id])
  
  @@index([organizationId])
  @@index([fareCode])
  @@index([origin, destination])
  @@index([cabinClass])
  @@index([validFrom, validTo])
  @@index([isActive])
  @@index([deletedAt])
  @@map("fares")
}

enum FareType {
  PUBLISHED
  PRIVATE
  NEGOTIATED
  PROMOTIONAL
  AWARD
  STAFF
}

enum RouteType {
  ONE_WAY
  ROUND_TRIP
  MULTI_CITY
  OPEN_JAW
}

// ============================================================================
// CORE ENTITIES - ANCILLARY PRODUCTS
// ============================================================================

model AncillaryProduct {
  id                    String                  @id @default(uuid())
  organizationId        String
  
  // Product identification
  productCode           String                  @unique
  productName           String
  category              AncillaryCategory
  
  // Pricing
  basePrice             Decimal                 @db.Decimal(10, 2)
  currency              String                  @default("USD")
  taxable               Boolean                 @default(true)
  
  // Availability
  isActive              Boolean                 @default(true)
  availableChannels     Json?                   // ["WEB", "MOBILE", "AGENT"]
  
  // Rules
  allowMultiple         Boolean                 @default(false)
  maxQuantity           Int?
  applicableCabins      Json?                   // ["ECONOMY", "BUSINESS"]
  applicableRoutes      Json?                   // [{origin: "JFK", destination: "LAX"}]
  
  // Description
  description           String?
  shortDescription      String?
  imageUrl              String?
  termsAndConditions    String?
  
  // Metadata
  metadata              Json?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  deletedAt             DateTime?

  // Relationships
  organization          Organization            @relation(fields: [organizationId], references: [id])
  pnrAncillaries        PNRAncillary[]
  
  @@index([organizationId])
  @@index([productCode])
  @@index([category])
  @@index([isActive])
  @@index([deletedAt])
  @@map("ancillary_products")
}

enum AncillaryCategory {
  BAGGAGE
  SEAT
  MEAL
  LOUNGE
  PRIORITY_BOARDING
  FAST_TRACK
  INSURANCE
  WIFI
  ENTERTAINMENT
  PET
  SPORTS_EQUIPMENT
  UPGRADE
  OTHER
}

model PNRAncillary {
  id                    String                  @id @default(uuid())
  pnrId                 String
  passengerId           String?                 // Null if applies to all passengers
  productId             String
  
  // Quantity and pricing
  quantity              Int                     @default(1)
  unitPrice             Decimal                 @db.Decimal(10, 2)
  totalPrice            Decimal                 @db.Decimal(10, 2)
  currency              String                  @default("USD")
  
  // Status
  status                AncillaryStatus         @default(CONFIRMED)
  
  // Metadata
  metadata              Json?                   // Product-specific data
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt

  // Relationships
  pnr                   PNR                     @relation(fields: [pnrId], references: [id], onDelete: Cascade)
  product               AncillaryProduct        @relation(fields: [productId], references: [id])
  
  @@index([pnrId])
  @@index([productId])
  @@map("pnr_ancillaries")
}

enum AncillaryStatus {
  CONFIRMED
  CANCELLED
  REFUNDED
  PENDING
}

// ============================================================================
// TICKETING
// ============================================================================

model Ticket {
  id                    String                  @id @default(uuid())
  pnrId                 String
  passengerId           String
  
  // Ticket details
  ticketNumber          String                  @unique // 13-digit IATA ticket number
  eTicketNumber         String?
  ticketType            TicketType              @default(ETICKET)
  
  // Status
  status                TicketStatus            @default(ISSUED)
  
  // Financial
  baseFare              Decimal                 @db.Decimal(10, 2)
  taxes                 Decimal                 @db.Decimal(10, 2)
  total                 Decimal                 @db.Decimal(10, 2)
  currency              String                  @default("USD")
  
  // Dates
  issueDate             DateTime                @default(now())
  validFrom             DateTime?
  validTo               DateTime?
  
  // Exchange and refund
  isRefundable          Boolean                 @default(false)
  isChangeable          Boolean                 @default(true)
  exchangedFrom         String?                 // Previous ticket number
  exchangedTo           String?                 // New ticket number
  
  // Metadata
  metadata              Json?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt

  // Relationships
  pnr                   PNR                     @relation(fields: [pnrId], references: [id])
  passenger             Passenger               @relation(fields: [passengerId], references: [id])
  refunds               Refund[]
  
  @@index([pnrId])
  @@index([passengerId])
  @@index([ticketNumber])
  @@index([status])
  @@map("tickets")
}

enum TicketType {
  ETICKET
  PAPER
  MCO
  EMD
}

enum TicketStatus {
  ISSUED
  USED
  EXCHANGED
  REFUNDED
  VOIDED
  EXPIRED
}

// ============================================================================
// OPERATIONAL TABLES - CHECK-IN
// ============================================================================

model CheckInTransaction {
  id                    String                  @id @default(uuid())
  organizationId        String
  pnrId                 String
  flightId              String
  
  // Agent information
  agentId               String?
  agentName             String?
  stationCode           String                  // Airport code
  
  // Transaction details
  transactionType       CheckInType
  status                CheckInStatus           @default(IN_PROGRESS)
  
  // Counts
  totalPassengers       Int
  checkedInPassengers   Int                     @default(0)
  
  // Timing
  startTime             DateTime                @default(now())
  completeTime          DateTime?
  duration              Int?                    // Seconds
  
  // Metadata
  metadata              Json?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt

  // Relationships
  organization          Organization            @relation(fields: [organizationId], references: [id])
  pnr                   PNR                     @relation(fields: [pnrId], references: [id])
  flight                Flight                  @relation(fields: [flightId], references: [id])
  passengerCheckIns     PassengerCheckIn[]
  
  @@index([organizationId])
  @@index([pnrId])
  @@index([flightId])
  @@index([status])
  @@index([startTime])
  @@map("checkin_transactions")
}

enum CheckInType {
  WEB
  MOBILE
  KIOSK
  AGENT
  CURBSIDE
}

enum CheckInStatus {
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
}

model PassengerCheckIn {
  id                    String                  @id @default(uuid())
  transactionId         String
  passengerId           String
  
  // Assigned seat
  seatNumber            String?
  cabinClass            CabinClass
  
  // Boarding details
  boardingZone          Int?
  boardingSequence      Int?
  boardingTime          DateTime?
  gate                  String?
  
  // Status
  status                PassengerCheckInStatus  @default(CHECKED_IN)
  
  // Timing
  checkInTime           DateTime                @default(now())
  
  // Metadata
  metadata              Json?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt

  // Relationships
  transaction           CheckInTransaction      @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  passenger             Passenger               @relation(fields: [passengerId], references: [id])
  
  @@index([transactionId])
  @@index([passengerId])
  @@index([status])
  @@map("passenger_checkins")
}

enum PassengerCheckInStatus {
  CHECKED_IN
  STANDBY
  CANCELLED
  NO_SHOW
  BOARDED
}

// ============================================================================
// OPERATIONAL TABLES - BOARDING
// ============================================================================

model BoardingPass {
  id                    String                  @id @default(uuid())
  passengerId           String
  
  // Boarding pass details
  boardingPassNumber    String                  @unique
  barcodeData           String                  // IATA BCBP format
  barcodeType           BarcodeType             @default(PDF417)
  
  // Flight and seat
  flightNumber          String
  origin                String
  destination           String
  departureDate         DateTime
  seatNumber            String?
  cabinClass            CabinClass
  
  // Boarding details
  boardingZone          Int?
  boardingSequence      Int?
  boardingTime          DateTime?
  gate                  String?
  
  // Status
  status                BoardingPassStatus      @default(ISSUED)
  boardedAt             DateTime?
  
  // Priority
  isPriority            Boolean                 @default(false)
  requiresAssistance    Boolean                 @default(false)
  
  // Metadata
  metadata              Json?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt

  // Relationships
  passenger             Passenger               @relation(fields: [passengerId], references: [id])
  boardingRecords       BoardingRecord[]
  
  @@index([passengerId])
  @@index([boardingPassNumber])
  @@index([flightNumber, departureDate])
  @@index([status])
  @@map("boarding_passes")
}

enum BarcodeType {
  PDF417
  QR_CODE
  AZTEC
  CODE128
}

enum BoardingPassStatus {
  ISSUED
  BOARDED
  CANCELLED
  EXPIRED
}

model BoardingRecord {
  id                    String                  @id @default(uuid())
  organizationId        String
  boardingPassId        String
  flightId              String
  
  // Scan details
  scanTime              DateTime                @default(now())
  scannedBy             String                  // Agent ID or gate reader ID
  gateNumber            String
  
  // Validation
  isValid               Boolean                 @default(true)
  validationStatus      ValidationStatus
  validationMessage     String?
  
  // Performance
  processingTime        Int?                    // Milliseconds
  
  // Metadata
  metadata              Json?
  createdAt             DateTime                @default(now())

  // Relationships
  organization          Organization            @relation(fields: [organizationId], references: [id])
  boardingPass          BoardingPass            @relation(fields: [boardingPassId], references: [id])
  flight                Flight                  @relation(fields: [flightId], references: [id])
  
  @@index([organizationId])
  @@index([boardingPassId])
  @@index([flightId])
  @@index([scanTime])
  @@map("boarding_records")
}

enum ValidationStatus {
  VALID
  INVALID_FLIGHT
  INVALID_DATE
  ALREADY_BOARDED
  GATE_CLOSED
  CANCELLED
  NO_SHOW
}

// ============================================================================
// OPERATIONAL TABLES - BAGGAGE
// ============================================================================

model BaggageTag {
  id                    String                  @id @default(uuid())
  organizationId        String
  passengerId           String
  
  // Tag details
  tagNumber             String                  @unique // 10-digit IATA tag number
  barcodeData           String
  
  // Routing
  origin                String                  // IATA airport code
  destination           String                  // IATA airport code
  finalDestination      String?                 // For connections
  
  // Bag details
  weight                Decimal                 @db.Decimal(6, 2)
  weightUnit            String                  @default("KG")
  bagType               BagType                 @default(CHECKED)
  
  // Status tracking
  status                BaggageStatus           @default(CHECKED)
  currentLocation       String?                 // Airport code
  
  // Flight
  flightNumber          String
  departureDate         DateTime
  
  // Charges
  isFree                Boolean                 @default(true)
  charge                Decimal?                @db.Decimal(10, 2)
  currency              String                  @default("USD")
  
  // Metadata
  metadata              Json?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt

  // Relationships
  organization          Organization            @relation(fields: [organizationId], references: [id])
  passenger             Passenger               @relation(fields: [passengerId], references: [id])
  trackingEvents        BaggageTrackingEvent[]
  
  @@index([organizationId])
  @@index([passengerId])
  @@index([tagNumber])
  @@index([status])
  @@index([flightNumber, departureDate])
  @@map("baggage_tags")
}

enum BagType {
  CHECKED
  CARRY_ON
  SPECIAL
  SPORTS
  OVERSIZED
}

enum BaggageStatus {
  CHECKED
  LOADED
  IN_TRANSIT
  ARRIVED
  CLAIMED
  DELAYED
  MISHANDLED
  LOST
}

model BaggageTrackingEvent {
  id                    String                  @id @default(uuid())
  baggageTagId          String
  
  // Event details
  eventType             BaggageEventType
  eventTime             DateTime                @default(now())
  location              String                  // Airport code
  
  // Status
  status                BaggageStatus
  
  // Agent/System
  scannedBy             String?
  
  // Metadata
  notes                 String?
  metadata              Json?
  createdAt             DateTime                @default(now())

  // Relationships
  baggageTag            BaggageTag              @relation(fields: [baggageTagId], references: [id], onDelete: Cascade)
  
  @@index([baggageTagId])
  @@index([eventTime])
  @@map("baggage_tracking_events")
}

enum BaggageEventType {
  CHECKED_IN
  LOADED
  UNLOADED
  TRANSFERRED
  ARRIVED
  CLAIMED
  DELAYED
  MISROUTED
  DAMAGED
  LOST
  FOUND
}

// ============================================================================
// OPERATIONAL TABLES - FLIGHT OPERATIONS
// ============================================================================

model FlightOperation {
  id                    String                  @id @default(uuid())
  flightId              String
  
  // Operations status
  operationalStatus     OperationalStatus       @default(ON_TIME)
  
  // Delay information
  delayMinutes          Int?
  delayReason           String?
  delayCode             String?                 // IATA delay code
  
  // Gate and terminal
  scheduledGate         String?
  actualGate            String?
  scheduledTerminal     String?
  actualTerminal        String?
  
  // Aircraft
  aircraftRegistration  String?
  tailNumber            String?
  
  // Crew
  captainName           String?
  crewCount             Int?
  
  // Fuel and weight
  fuelOnBoard           Decimal?                @db.Decimal(10, 2)
  fuelUnit              String?                 @default("KG")
  
  // Weather
  weatherCondition      String?
  visibility            String?
  
  // Remarks
  remarks               String?
  metadata              Json?
  
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt

  // Relationships
  flight                Flight                  @relation(fields: [flightId], references: [id], onDelete: Cascade)
  
  @@index([flightId])
  @@index([operationalStatus])
  @@map("flight_operations")
}

enum OperationalStatus {
  ON_TIME
  DELAYED
  CANCELLED
  DIVERTED
  RETURNED
  AIR_TURNBACK
}

model LoadControl {
  id                    String                  @id @default(uuid())
  flightId              String                  @unique
  
  // Passenger load
  totalPassengers       Int                     @default(0)
  adultCount            Int                     @default(0)
  childCount            Int                     @default(0)
  infantCount           Int                     @default(0)
  
  // Cabin breakdown
  firstClassCount       Int                     @default(0)
  businessClassCount    Int                     @default(0)
  economyClassCount     Int                     @default(0)
  
  // Baggage
  totalBags             Int                     @default(0)
  totalBaggageWeight    Decimal                 @default(0) @db.Decimal(10, 2)
  
  // Cargo
  cargoWeight           Decimal                 @default(0) @db.Decimal(10, 2)
  mailWeight            Decimal                 @default(0) @db.Decimal(10, 2)
  
  // Weight calculations
  totalWeight           Decimal                 @default(0) @db.Decimal(10, 2)
  weightUnit            String                  @default("KG")
  
  // Balance
  centerOfGravity       Decimal?                @db.Decimal(6, 2)
  isWithinLimits        Boolean                 @default(true)
  
  // Status
  status                LoadControlStatus       @default(OPEN)
  closedAt              DateTime?
  closedBy              String?
  
  // Metadata
  metadata              Json?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt

  // Relationships
  flight                Flight                  @relation(fields: [flightId], references: [id], onDelete: Cascade)
  
  @@index([flightId])
  @@index([status])
  @@map("load_control")
}

enum LoadControlStatus {
  OPEN
  PRELIMINARY
  FINAL
  CLOSED
}

// ============================================================================
// SPECIAL SERVICE REQUESTS (SSR)
// ============================================================================

model SpecialServiceRequest {
  id                    String                  @id @default(uuid())
  pnrId                 String
  passengerId           String?                 // Null if applies to entire booking
  
  // SSR details
  ssrCode               String                  // IATA SSR code (WCHR, VGML, etc.)
  ssrType               SSRType
  description           String
  
  // Status
  status                SSRStatus               @default(REQUESTED)
  
  // Fulfillment
  confirmedBy           String?
  confirmedAt           DateTime?
  notes                 String?
  
  // Metadata
  metadata              Json?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt

  // Relationships
  pnr                   PNR                     @relation(fields: [pnrId], references: [id], onDelete: Cascade)
  passenger             Passenger?              @relation(fields: [passengerId], references: [id])
  
  @@index([pnrId])
  @@index([passengerId])
  @@index([ssrCode])
  @@index([status])
  @@map("special_service_requests")
}

enum SSRType {
  MEAL
  MEDICAL
  WHEELCHAIR
  UNACCOMPANIED_MINOR
  PET
  INFANT
  SPECIAL_BAGGAGE
  VIP
  OTHER
}

enum SSRStatus {
  REQUESTED
  CONFIRMED
  DENIED
  CANCELLED
}

// ============================================================================
// FINANCIAL TABLES - PAYMENTS
// ============================================================================

model Payment {
  id                    String                  @id @default(uuid())
  organizationId        String
  pnrId                 String
  
  // Payment details
  amount                Decimal                 @db.Decimal(10, 2)
  currency              String                  @default("USD")
  paymentMethod         PaymentMethod
  
  // Status
  status                PaymentTransactionStatus @default(PENDING)
  
  // Gateway
  gatewayProvider       String?                 // Stripe, PayPal, etc.
  gatewayTransactionId  String?                 @unique
  gatewayResponse       Json?
  
  // Card details (if applicable, tokenized)
  cardType              String?                 // Visa, MasterCard, Amex
  cardLast4             String?
  cardToken             String?
  
  // Billing
  billingName           String
  billingEmail          String
  billingAddress        Json?
  
  // Reconciliation
  settledAt             DateTime?
  settlementBatch       String?
  
  // Metadata
  metadata              Json?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt

  // Relationships
  organization          Organization            @relation(fields: [organizationId], references: [id])
  pnr                   PNR                     @relation(fields: [pnrId], references: [id])
  refunds               Refund[]
  
  @@index([organizationId])
  @@index([pnrId])
  @@index([gatewayTransactionId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  PAYPAL
  BANK_TRANSFER
  CASH
  VOUCHER
  POINTS
  CRYPTO
}

enum PaymentTransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
  PARTIALLY_REFUNDED
}

model Refund {
  id                    String                  @id @default(uuid())
  paymentId             String
  ticketId              String?
  
  // Refund details
  amount                Decimal                 @db.Decimal(10, 2)
  currency              String                  @default("USD")
  refundType            RefundType
  
  // Reason
  reason                String
  reasonCode            String?
  
  // Status
  status                RefundStatus            @default(PENDING)
  
  // Processing
  processedBy           String?
  processedAt           DateTime?
  
  // Gateway
  gatewayRefundId       String?
  gatewayResponse       Json?
  
  // Metadata
  metadata              Json?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt

  // Relationships
  payment               Payment                 @relation(fields: [paymentId], references: [id])
  ticket                Ticket?                 @relation(fields: [ticketId], references: [id])
  
  @@index([paymentId])
  @@index([ticketId])
  @@index([status])
  @@index([createdAt])
  @@map("refunds")
}

enum RefundType {
  FULL
  PARTIAL
  CANCELLATION_FEE
  CHANGE_FEE
  VOLUNTARY
  INVOLUNTARY
}

enum RefundStatus {
  PENDING
  APPROVED
  PROCESSING
  COMPLETED
  REJECTED
  FAILED
}

model RevenueAccounting {
  id                    String                  @id @default(uuid())
  organizationId        String
  
  // Period
  accountingPeriod      String                  // YYYY-MM
  accountingDate        DateTime
  
  // Revenue categories
  ticketRevenue         Decimal                 @default(0) @db.Decimal(12, 2)
  ancillaryRevenue      Decimal                 @default(0) @db.Decimal(12, 2)
  baggageRevenue        Decimal                 @default(0) @db.Decimal(12, 2)
  seatRevenue           Decimal                 @default(0) @db.Decimal(12, 2)
  otherRevenue          Decimal                 @default(0) @db.Decimal(12, 2)
  
  // Adjustments
  refunds               Decimal                 @default(0) @db.Decimal(12, 2)
  adjustments           Decimal                 @default(0) @db.Decimal(12, 2)
  
  // Net revenue
  grossRevenue          Decimal                 @default(0) @db.Decimal(12, 2)
  netRevenue            Decimal                 @default(0) @db.Decimal(12, 2)
  
  // Currency
  currency              String                  @default("USD")
  
  // Status
  status                AccountingStatus        @default(DRAFT)
  reconciledAt          DateTime?
  
  // Metadata
  metadata              Json?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt

  @@unique([organizationId, accountingPeriod])
  @@index([organizationId])
  @@index([accountingPeriod])
  @@index([accountingDate])
  @@map("revenue_accounting")
}

enum AccountingStatus {
  DRAFT
  PENDING
  RECONCILED
  CLOSED
}

model Commission {
  id                    String                  @id @default(uuid())
  organizationId        String
  
  // Agent/Agency
  agentId               String
  agentName             String
  agencyCode            String?
  
  // Booking reference
  pnrLocator            String
  ticketNumber          String?
  
  // Commission calculation
  baseAmount            Decimal                 @db.Decimal(10, 2)
  commissionRate        Decimal                 @db.Decimal(5, 2) // Percentage
  commissionAmount      Decimal                 @db.Decimal(10, 2)
  currency              String                  @default("USD")
  
  // Status
  status                CommissionStatus        @default(PENDING)
  
  // Payment
  paidAt                DateTime?
  paymentReference      String?
  
  // Metadata
  metadata              Json?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt

  @@index([organizationId])
  @@index([agentId])
  @@index([pnrLocator])
  @@index([status])
  @@map("commissions")
}

enum CommissionStatus {
  PENDING
  APPROVED
  PAID
  CANCELLED
}

// ============================================================================
// USER & ACCESS MANAGEMENT
// ============================================================================

model User {
  id                    String                  @id @default(uuid())
  organizationId        String
  
  // Basic info
  email                 String                  @unique
  username              String?                 @unique
  passwordHash          String
  
  // Profile
  firstName             String
  lastName              String
  phone                 String?
  
  // Status
  status                UserStatus              @default(ACTIVE)
  emailVerified         Boolean                 @default(false)
  emailVerifiedAt       DateTime?
  
  // Security
  lastLoginAt           DateTime?
  lastLoginIp           String?
  failedLoginAttempts   Int                     @default(0)
  lockedUntil           DateTime?
  mustChangePassword    Boolean                 @default(false)
  
  // MFA
  mfaEnabled            Boolean                 @default(false)
  mfaSecret             String?
  
  // Metadata
  metadata              Json?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  deletedAt             DateTime?

  // Relationships
  organization          Organization            @relation(fields: [organizationId], references: [id])
  roles                 UserRole[]
  apiKeys               ApiKey[]
  auditLogs             AuditLog[]
  
  @@index([organizationId])
  @@index([email])
  @@index([username])
  @@index([status])
  @@index([deletedAt])
  @@map("users")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  LOCKED
}

model Role {
  id                    String                  @id @default(uuid())
  
  // Role details
  name                  String                  @unique
  displayName           String
  description           String?
  
  // Type
  isSystem              Boolean                 @default(false)
  level                 RoleLevel               @default(USER)
  
  // Status
  isActive              Boolean                 @default(true)
  
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt

  // Relationships
  userRoles             UserRole[]
  permissions           RolePermission[]
  
  @@index([name])
  @@index([isActive])
  @@map("roles")
}

enum RoleLevel {
  SUPER_ADMIN
  ADMIN
  MANAGER
  AGENT
  USER
}

model UserRole {
  id                    String                  @id @default(uuid())
  userId                String
  roleId                String
  
  // Assignment
  assignedBy            String?
  assignedAt            DateTime                @default(now())
  
  // Validity
  validFrom             DateTime?
  validTo               DateTime?

  // Relationships
  user                  User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  role                  Role                    @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

model Permission {
  id                    String                  @id @default(uuid())
  
  // Permission details
  name                  String                  @unique
  resource              String                  // e.g., "pnr", "flight", "user"
  action                PermissionAction
  
  // Description
  displayName           String
  description           String?
  
  createdAt             DateTime                @default(now())

  // Relationships
  rolePermissions       RolePermission[]
  
  @@index([name])
  @@index([resource])
  @@map("permissions")
}

enum PermissionAction {
  CREATE
  READ
  UPDATE
  DELETE
  EXECUTE
  MANAGE
}

model RolePermission {
  id                    String                  @id @default(uuid())
  roleId                String
  permissionId          String
  
  createdAt             DateTime                @default(now())

  // Relationships
  role                  Role                    @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission            Permission              @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

model ApiKey {
  id                    String                  @id @default(uuid())
  userId                String
  
  // Key details
  name                  String
  keyHash               String                  @unique
  keyPrefix             String                  // First 8 chars for identification
  
  // Scope
  scopes                Json?                   // Array of allowed scopes
  
  // Usage limits
  rateLimit             Int?                    // Requests per minute
  
  // Status
  isActive              Boolean                 @default(true)
  
  // Validity
  expiresAt             DateTime?
  lastUsedAt            DateTime?
  
  // Metadata
  metadata              Json?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt

  // Relationships
  user                  User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([keyHash])
  @@index([keyPrefix])
  @@index([isActive])
  @@map("api_keys")
}

model AuditLog {
  id                    String                  @id @default(uuid())
  
  // Actor
  userId                String?
  userEmail             String?
  ipAddress             String?
  userAgent             String?
  
  // Action
  action                AuditAction
  resource              String                  // Table or entity name
  resourceId            String?                 // ID of affected record
  
  // Details
  oldValues             Json?
  newValues             Json?
  
  // Context
  organizationId        String?
  
  // Metadata
  metadata              Json?
  timestamp             DateTime                @default(now())

  // Relationships
  user                  User?                   @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([resourceId])
  @@index([organizationId])
  @@index([timestamp])
  @@map("audit_logs")
}

enum AuditAction {
  CREATE
  READ
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  LOGIN_FAILED
  PASSWORD_CHANGE
  PERMISSION_CHANGE
  EXPORT
  IMPORT
}

// ============================================================================
// ANALYTICS TABLES
// ============================================================================

model CustomerSegment {
  id                    String                  @id @default(uuid())
  organizationId        String
  
  // Segment details
  name                  String
  description           String?
  
  // Criteria
  criteria              Json                    // Segmentation rules
  
  // Status
  isActive              Boolean                 @default(true)
  
  // Stats
  customerCount         Int                     @default(0)
  lastCalculated        DateTime?
  
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt

  @@index([organizationId])
  @@index([isActive])
  @@map("customer_segments")
}

model BookingAnalytics {
  id                    String                  @id @default(uuid())
  organizationId        String
  
  // Time period
  analyticsDate         DateTime
  period                AnalyticsPeriod         @default(DAY)
  
  // Booking metrics
  totalBookings         Int                     @default(0)
  totalPassengers       Int                     @default(0)
  totalRevenue          Decimal                 @default(0) @db.Decimal(12, 2)
  
  // Channel breakdown
  webBookings           Int                     @default(0)
  mobileBookings        Int                     @default(0)
  agentBookings         Int                     @default(0)
  apiBookings           Int                     @default(0)
  
  // Conversion
  searchCount           Int                     @default(0)
  conversionRate        Decimal?                @db.Decimal(5, 2)
  
  // Average values
  avgBookingValue       Decimal?                @db.Decimal(10, 2)
  avgPassengersPerBooking Decimal?              @db.Decimal(4, 2)
  
  // Ancillary
  ancillaryRevenue      Decimal                 @default(0) @db.Decimal(12, 2)
  ancillaryAttachRate   Decimal?                @db.Decimal(5, 2)
  
  currency              String                  @default("USD")
  
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt

  @@unique([organizationId, analyticsDate, period])
  @@index([organizationId])
  @@index([analyticsDate])
  @@map("booking_analytics")
}

enum AnalyticsPeriod {
  HOUR
  DAY
  WEEK
  MONTH
  QUARTER
  YEAR
}

model PerformanceMetric {
  id                    String                  @id @default(uuid())
  organizationId        String
  
  // Metric details
  metricName            String
  metricType            MetricType
  metricValue           Decimal                 @db.Decimal(12, 4)
  unit                  String?
  
  // Context
  flightId              String?
  route                 String?                 // Origin-Destination pair
  
  // Time
  measurementDate       DateTime
  period                AnalyticsPeriod         @default(DAY)
  
  // Metadata
  metadata              Json?
  createdAt             DateTime                @default(now())

  @@index([organizationId])
  @@index([metricName])
  @@index([measurementDate])
  @@map("performance_metrics")
}

enum MetricType {
  LOAD_FACTOR
  REVENUE_PER_SEAT
  ON_TIME_PERFORMANCE
  CANCELLATION_RATE
  CUSTOMER_SATISFACTION
  ANCILLARY_REVENUE_PER_PASSENGER
  AVERAGE_FARE
  BOOKING_CONVERSION_RATE
}

model Campaign {
  id                    String                  @id @default(uuid())
  organizationId        String
  
  // Campaign details
  name                  String
  code                  String                  @unique
  description           String?
  campaignType          CampaignType
  
  // Dates
  startDate             DateTime
  endDate               DateTime
  
  // Targeting
  targetSegments        Json?                   // Array of segment IDs
  targetRoutes          Json?                   // Array of route codes
  
  // Discount/Offer
  discountType          DiscountType?
  discountValue         Decimal?                @db.Decimal(10, 2)
  discountPercentage    Decimal?                @db.Decimal(5, 2)
  
  // Budget
  budget                Decimal?                @db.Decimal(12, 2)
  spent                 Decimal                 @default(0) @db.Decimal(12, 2)
  
  // Performance
  bookingCount          Int                     @default(0)
  revenueGenerated      Decimal                 @default(0) @db.Decimal(12, 2)
  
  // Status
  status                CampaignStatus          @default(DRAFT)
  
  // Metadata
  metadata              Json?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  deletedAt             DateTime?

  // Relationships
  organization          Organization            @relation(fields: [organizationId], references: [id])
  
  @@index([organizationId])
  @@index([code])
  @@index([status])
  @@index([startDate, endDate])
  @@index([deletedAt])
  @@map("campaigns")
}

enum CampaignType {
  PROMOTIONAL
  SEASONAL
  FLASH_SALE
  LOYALTY
  REMARKETING
  REFERRAL
}

enum DiscountType {
  FIXED_AMOUNT
  PERCENTAGE
  BUY_ONE_GET_ONE
  FREE_ANCILLARY
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}
